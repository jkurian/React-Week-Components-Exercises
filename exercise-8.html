<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>Hello React</title>
    <script src="https://unpkg.com/react@latest/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@latest/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/babel-standalone@6.15.0/babel.min.js"></script>
    <link href="./style.css" rel="stylesheet"/>
  </head>
  <body>
    <div class="container">
      <h1>Get It Done! <br/><small>For the truly industrious</small></h1>
      <div id="root">
        <table>
          <thead>
            <tr><td>Task</td><td>Done?</td></tr>
          </thead>
          <tbody>
            <!-- Show while loading -->
            <tr>
              <td colspan='2'>Loading Tasks...</td>
            </tr>
            <!-- Show Results -->
            <tr>
              <td>Walk Dog</td><td><input type='checkbox' checked/></td>
            </tr>
            <tr>
              <td>Buy Bread</td><td><input type='checkbox'/></td>
            </tr>
          </tbody>
        </table>
        <hr/>
        <form>
          <input type='text' placeholder="Write Task Name"/>
          <button type='submit'>Add</button>
        </form>
      </div>
    </div>
    <script src='./rando.js'></script>
    <script src='./delay.js'></script>
    <script src="./task-svc.js"></script>
    <script type="text/babel">
    const {
      // Gets all current tasks.
      // () => Promise<Tasks[]>
      getTasks, 

      // Creates a new task, adding an id and returning it.
      // (taskName:String) => Promise<Task>
      addTask, 

      // Finds a task by id and switches its "finished" flag
      // (id:String) => Promise<Task>
      toggleTask,
    } = taskSvc;

    const root = document.getElementById('root');

    var rando = (function(){
      var letters = 'abcdefghijklmnopqrstuvwxyz';
      var alphabet = `0123456789${letters}${letters.toUpperCase()}`;

      var randomNum = (function random(){
      var output = '';
        for (var i = 0; i < 6; i += 1) {
          output += alphabet[Math.floor(Math.random() * alphabet.length)];
        }
        return output;
      })();
      return randomNum;
    });

    // TYPE ANSWER HERE
    function NewToDoForm ({addTodoItem}) {
      const onSubmit = (evt) => {
      evt.preventDefault();
      const taskName = evt.target.elements.taskName.value;
      const task = {taskName: taskName, finished: false, id: rando()}
      addTodoItem(task);
      evt.target.elements.taskName.value = '';
    }
    return (<div>
     <p>Enter a new task!</p>
      <form onSubmit={onSubmit}>
        <input type='text' name='taskName'/>
        <button type='submit'>Add Task</button>
      </form>
    </div>);
}


  function TodoItem({id, deleteTask, taskName}){
  const onClick = (evt) => {
      evt.preventDefault();
      deleteTask(id);
    };
  return (<li id={id}>
    {taskName}
    <button onClick={onClick}>
        Delete
    </button>
    </li>);
}

class TodoList extends React.Component {
constructor(props){
  super(props);
  this.state = { tasks: [{taskName: 'Walk Dog', finished: false, id: rando()}, {taskName: 'Buy Bread', finished: false, id:rando()}], loading: true };
  this.addTodoItem = this.addTodoItem.bind(this);
  this.deleteTask = this.deleteTask.bind(this);
}
addTodoItem(task) {
  const oldTasks = this.state.tasks;
  // console.log(this.state);
  this.setState({tasks: oldTasks, loading: true})
   console.log('after settingState', this.state);
   addTask(task.taskName)
   .then((newTask) => {
     this.setState({tasks: oldTasks, loading: false, newTask: newTask});
   })
}
deleteTask(id) {
  const oldTasks = this.state.tasks;
  this.setState({tasks: oldTasks, loading: true})
  toggleTask(id)
  .then(() => {
    let updatedTasks = oldTasks.filter(task => task.id !== id);        
    this.setState({tasks: updatedTasks, loading: false})

  })
}
componentDidMount() {
  console.log(this.state);
  getTasks()
    .then((tasks) => {
      this.setState({ tasks: tasks, loading: false });
    })
}
render(){
  if(this.state.loading){
    return (<div>
    <p>TODO List</p>
    <ul>
      <li>Loading...</li>
    </ul>
    <NewToDoForm addTodoItem={this.addTodoItem}/>
 </div>);
  }
  const todoItems = this.state.tasks.map((task) => {
    return <TodoItem taskName={task.taskName} id={task.id} deleteTask={this.deleteTask}/>
  })
  if(this.state.newTask) {
    todoItems.push(<TodoItem taskName={this.state.newTask.taskName} id={this.state.newTask.id} deleteTask={this.deleteTask}/>);
  }
  return (<div>
    <p>TODO List</p>
    <ul>
      {todoItems}
    </ul>
    <NewToDoForm addTodoItem={this.addTodoItem}/>
 </div>);
}
}
ReactDOM.render(
( <TodoList/>
),
root);
    </script>
  </body>
</html>
